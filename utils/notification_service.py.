import streamlit as st
from datetime import datetime
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

class NotificationService:
    def __init__(self):
        if 'notifications' not in st.session_state:
            st.session_state.notifications = []
            
    def _send_real_email(self, to_email, subject, body):
        try:
            if "email" in st.secrets:
                sender_email = st.secrets["email"]["sender_email"]
                password = st.secrets["email"]["app_password"]
                smtp_server = st.secrets["email"]["smtp_server"]
                smtp_port = st.secrets["email"]["smtp_port"]
                msg = MIMEMultipart()
                msg['From'] = sender_email
                msg['To'] = to_email
                msg['Subject'] = subject
                msg.attach(MIMEText(body, 'plain'))
                with smtplib.SMTP(smtp_server, smtp_port) as server:
                    server.starttls()
                    server.login(sender_email, password)
                    server.send_message(msg)
                return True
        except: return False
        return False

    def send_application_email(self, job, user_email=None):
        if not user_email: user_email = "user@example.com"
        subject = f"Application Confirmed: {job['title']} at {job['company']}"
        body = f"Sent to: {user_email}\n\nYou applied for {job['title']} at {job['company']}."
        is_sent = self._send_real_email(user_email, subject, body)
        self.session_state.notifications.append({"id": len(st.session_state.notifications) + 1, "type": "Application", "subject": subject, "body": body, "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "read": False})
        return True

    def send_shortlist_email(self, app_data, user_email=None):
        if not user_email: user_email = "user@example.com"
        subject = f"ðŸŽ‰ Shortlisted: {app_data['Company']}"
        body = f"Sent to: {user_email}\n\nYou are shortlisted for {app_data['Role']}!"
        is_sent = self._send_real_email(user_email, subject, body)
        self.session_state.notifications.append({"id": len(st.session_state.notifications) + 1, "type": "Shortlist", "subject": subject, "body": body, "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "read": False})
        return True

    def send_sms(self, message, phone=None):
        self.session_state.notifications.append({"id": len(st.session_state.notifications) + 1, "type": f"SMS to {phone or 'Unknown'}", "subject": "ðŸ’¬ SMS Alert", "body": message, "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "read": False})
        return True

    def get_notifications(self):
        return sorted(st.session_state.notifications, key=lambda x: x['timestamp'], reverse=True)
